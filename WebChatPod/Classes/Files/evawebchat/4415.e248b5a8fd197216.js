"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4415],{4415:(j,w,T)=>{T.d(w,{m:()=>m});var g=T(467),A=T(4202),p=T(2931);const r={PRODUCTION:p.c.production,VASERVER:p.c.vaserver,EVA_BOT_CONFIG:p.c.evaBotConfig,EVA_TTS_CONFIG:p.c.evaTTSConfig,EVA_TTS_SYNTHESIZESPEECH_URL:p.c.evaTTSConfig.domain+"/synthesizeSpeech",EVA_TTS_DOWNLOADAUDIO_URL:p.c.evaTTSConfig.domain+"/download_v2?audio_url="};var t=T(4438),u=T(1075),f=T(177),C=T(4341);function R(c,s){if(1&c){const i=t.RV6();t.j41(0,"ion-toggle",7),t.bIt("ionChange",function(n){t.eBV(i);const a=t.XpG().$implicit,o=t.XpG();return t.Njj(o.updateConfiguration(n,a.id))}),t.EFF(1),t.k0s()}if(2&c){const i=t.XpG().$implicit;t.Y8G("enableOnOffLabels",!0)("checked",i.checked),t.R7$(),t.SpI(" ",i.label," ")}}function k(c,s){if(1&c&&(t.j41(0,"ion-select-option",10),t.EFF(1),t.k0s()),2&c){const i=s.$implicit;t.Y8G("value",i.id),t.R7$(),t.SpI(" ",i.label," ")}}function N(c,s){if(1&c){const i=t.RV6();t.j41(0,"ion-select",8),t.mxI("ngModelChange",function(n){t.eBV(i);const a=t.XpG().$implicit;return t.DH7(a.selected,n)||(a.selected=n),t.Njj(n)}),t.bIt("ionChange",function(n){t.eBV(i);const a=t.XpG().$implicit,o=t.XpG();return t.Njj(o.updateConfiguration(n,a.id))}),t.DNE(1,k,2,2,"ion-select-option",9),t.k0s()}if(2&c){const i=t.XpG().$implicit;t.R50("ngModel",i.selected),t.R7$(),t.Y8G("ngForOf",i.options)}}function P(c,s){if(1&c&&(t.j41(0,"ion-item"),t.DNE(1,R,2,3,"ion-toggle",5)(2,N,2,2,"ion-select",6),t.k0s()),2&c){const i=s.$implicit;t.R7$(),t.Y8G("ngIf","toggle"==i.type),t.R7$(),t.Y8G("ngIf","dropdown"==i.type)}}let V=(()=>{var c;class s{constructor(e){this.modalCtrl=e}ngOnInit(){try{this.userSettings=JSON.parse(JSON.stringify(this.selectedUserSettings))}catch(e){console.error(e)}}closeModal(e){return"confirm"==e&&(this.selectedUserSettings=this.userSettings),this.modalCtrl.dismiss(this.selectedUserSettings,e)}updateConfiguration(e,n){var a;null==(a=this.userSettings)||a.forEach(o=>{o.id==n&&("toggle"==o.type&&(o.checked=e.detail.checked),"dropdown"==o.type&&(o.selected=e.detail.value))})}}return(c=s).\u0275fac=function(e){return new(e||c)(t.rXU(u.W3))},c.\u0275cmp=t.VBU({type:c,selectors:[["app-webchat-settings-modal"]],inputs:{selectedUserSettings:"selectedUserSettings"},decls:15,vars:1,consts:[[1,"ion-padding"],["lines","none"],[4,"ngFor","ngForOf"],["slot","end"],[3,"click"],[3,"enableOnOffLabels","checked","ionChange",4,"ngIf"],["interface","alert","label","Domain",3,"ngModel","ngModelChange","ionChange",4,"ngIf"],[3,"ionChange","enableOnOffLabels","checked"],["interface","alert","label","Domain",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"value"]],template:function(e,n){1&e&&(t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t.EFF(3,"Configuration"),t.k0s()()(),t.j41(4,"ion-content",0)(5,"ion-list",1),t.DNE(6,P,3,2,"ion-item",2),t.k0s()(),t.j41(7,"ion-footer")(8,"ion-toolbar")(9,"ion-buttons",3)(10,"ion-button",4),t.bIt("click",function(){return n.closeModal("cancel")}),t.EFF(11,"CANCEL"),t.k0s()(),t.j41(12,"ion-buttons",3)(13,"ion-button",4),t.bIt("click",function(){return n.closeModal("confirm")}),t.EFF(14,"OK"),t.k0s()()()()),2&e&&(t.R7$(6),t.Y8G("ngForOf",n.userSettings))},dependencies:[f.Sq,f.bT,u.Jm,u.QW,u.W9,u.M0,u.eU,u.uz,u.nf,u.Nm,u.Ip,u.BC,u.BY,u.ai,u.hB,u.Je,C.BC,C.vS],styles:["ion-title[_ngcontent-%COMP%]{color:#000}ion-buttons[_ngcontent-%COMP%]{color:#0054e9}"]}),s})(),O=(()=>{class s{}return s.BASE_IMAGES="./assets/images/",s})();var y=T(345),b=T(1626),I=T(5311),L=T(9901);let M=(()=>{var c;class s{constructor(e){this.evaLaunchappService=e}isWebApp(){return navigator&&(navigator.userAgent.includes("Win32")||navigator.userAgent.includes("Win64"))||window.location.href.startsWith("http://localhost")||window.location.href.startsWith("http://0.0.0.0")||scxmlHandler&&1==scxmlHandler.DEBUG_MODE||!L.j.getEvaConfigurationProperty("isEvaMobileApp")}isDeveloperModeEnabled(){return 1==r.DEVELOPER_MODE_ENABLED}openLink(e){try{e&&e.trim().length>0&&(this.isWebApp()?window.open(e):this.evaLaunchappService.openLink(e).then(n=>{}).catch(n=>{console.error("CommonUtil :: openLink :: error = ",n)}))}catch{}}isNetworkAvailable(){return!(!navigator||!navigator.onLine)}}return(c=s).\u0275fac=function(e){return new(e||c)(t.KVO(I.w3))},c.\u0275prov=t.jDH({token:c,factory:c.\u0275fac,providedIn:"root"}),s})();var D=T(8969),F=T(8986);let B=(()=>{var c;class s{constructor(e,n,a,o,h,d,l){this.httpClient=e,this.router=n,this.alertCtrl=a,this.loadingCtrl=o,this.modalController=h,this.domSanitizer=d,this.toastController=l,this.isLoading=!1}makeHTTPRequest(e,n,a,o,h){return"get"==e.toLowerCase()?this.httpClient.get(n,o):"post"==e.toLowerCase()?this.httpClient.post(n,a,o):void 0}getHeaderOptions(){let e=new b.Lr;return e.append("Accept","application/json; charset=utf-8"),e.append("Content-Type","application/json"),{headers:e,params:new b.Nl,reportProgress:!1}}routerNavigate(e,n){this.router.navigate([e],{state:{data:n}}).catch(a=>{this.router.navigate([D.N.EVA_URI_HOME])})}getRouterNavigationData(){const e=this.router.getCurrentNavigation();let n=e?e.extras:null;!n&&history&&history.state&&(n=history);const a=n?n.state:null;return a?a.data:null}showAlert(e){var n=this;return(0,g.A)(function*(){return yield n.hideAlert(),new Promise(function(){var a=(0,g.A)(function*(o){let h=!1,d="custom-alert";e&&e.hasOwnProperty("backdropDismiss")&&(h=e.backdropDismiss),e&&e.hasOwnProperty("cssClass")&&(d=e.cssClass),n.ionicAlert=yield n.alertCtrl.create({header:null!=e&&e.header?e.header:"",subHeader:null!=e&&e.subHeader?e.subHeader:"",message:null!=e&&e.message?e.message:"",cssClass:d,backdropDismiss:h,buttons:[{text:null!=e&&e.okText?e.okText:"OK",handler:()=>(n.ionicAlert.dismiss(),o(!0))}]}),setTimeout((0,g.A)(function*(){yield n.ionicAlert.present()}),200)});return function(o){return a.apply(this,arguments)}}())})()}confirmationAlert(e){var n=this;return(0,g.A)(function*(){return yield n.hideAlert(),new Promise(function(){var a=(0,g.A)(function*(o){let h=!1,d="custom-alert";e&&e.hasOwnProperty("backdropDismiss")&&(h=e.backdropDismiss),e&&e.hasOwnProperty("cssClass")&&(d=e.cssClass),n.ionicAlert=yield n.alertCtrl.create({header:null!=e&&e.header?e.header:"",subHeader:null!=e&&e.subHeader?e.subHeader:"",message:null!=e&&e.message?e.message:"",cssClass:d,backdropDismiss:h,buttons:[{text:null!=e&&e.okText?e.okText:"YES",handler:()=>o(!0)},{text:null!=e&&e.cancelText?e.cancelText:"NO",role:"cancel",handler:()=>o(!1)}]}),setTimeout((0,g.A)(function*(){yield n.ionicAlert.present()}),200)});return function(o){return a.apply(this,arguments)}}())})()}hideAlert(){var e=this;return(0,g.A)(function*(){e.ionicAlert&&e.ionicAlert.dismiss()})()}showLoader(e){var n=this;return(0,g.A)(function*(){let a;e&&(a={},e.hasOwnProperty("spinner")&&(a.spinner=e.spinner),e.hasOwnProperty("message")&&(a.message=e.message),e.hasOwnProperty("cssClass")&&(a.cssClass=e.cssClass),e.hasOwnProperty("showBackdrop")&&(a.showBackdrop=e.showBackdrop),e.hasOwnProperty("duration")&&(a.duration=e.duration),e.hasOwnProperty("translucent")&&(a.translucent=e.translucent),e.hasOwnProperty("animated")&&(a.animated=e.animated),e.hasOwnProperty("backdropDismiss")&&(a.backdropDismiss=e.backdropDismiss),e.hasOwnProperty("mode")&&(a.mode=e.mode),e.hasOwnProperty("keyboardClose")&&(a.keyboardClose=e.keyboardClose),e.hasOwnProperty("id")&&(a.id=e.id),e.hasOwnProperty("htmlAttributes")&&(a.htmlAttributes=e.htmlAttributes)),n.isLoading=!0,(yield n.loadingCtrl.create(a)).present()})()}hideLoader(){var e=this;return(0,g.A)(function*(){try{e.isLoading?(e.isLoading=!1,yield e.loadingCtrl.dismiss()):e.loadingCtrl.getTop().then(function(){var n=(0,g.A)(function*(a){return a?yield e.loadingCtrl.dismiss():null});return function(a){return n.apply(this,arguments)}}()).catch(n=>{})}catch{}finally{yield e.hideLoaderWhichAreOpen()}})()}hideLoaderWhichAreOpen(){var e=this;return(0,g.A)(function*(){try{const n=yield e.loadingCtrl.getTop().catch(a=>{});n&&(yield n.dismiss(null))}catch{}})()}bypassSecurityTrustResourceUrl(e){return e?this.domSanitizer.bypassSecurityTrustResourceUrl(e):null}bypassSecurityTrustHtml(e){return e?this.domSanitizer.bypassSecurityTrustHtml(e):null}dismissModal(){var e=this;return(0,g.A)(function*(){(yield e.modalController.getTop())&&e.modalController.dismiss({})})()}presentToast(e,n,a){var o=this;return(0,g.A)(function*(){yield(yield o.toastController.create({message:e,duration:n,position:a||"top",cssClass:"custom-toast"})).present()})()}}return(c=s).\u0275fac=function(e){return new(e||c)(t.KVO(b.Qq),t.KVO(F.Ix),t.KVO(u.hG),t.KVO(u.Xi),t.KVO(u.W3),t.KVO(y.up),t.KVO(u.K_))},c.\u0275prov=t.jDH({token:c,factory:c.\u0275fac,providedIn:"root"}),s})();var _;const U=["langSelect"];function G(c,s){if(1&c&&(t.j41(0,"ion-select-option",16),t.EFF(1),t.k0s()),2&c){const i=s.$implicit;t.Y8G("value",i.lang_code),t.R7$(),t.SpI(" ",i.name," ")}}function W(c,s){if(1&c&&(t.j41(0,"div",17)(1,"div",18),t.nrm(2,"iframe",19),t.k0s(),t.j41(3,"div",20),t.nrm(4,"div",21),t.k0s()()),2&c){const i=t.XpG();t.R7$(2),t.Y8G("src",i.avatar_url,t.f$h)}}function x(c,s){1&c&&(t.j41(0,"div",17),t.nrm(1,"div",21),t.k0s())}class m{constructor(s,i,e,n,a,o,h,d,l){this.domSanitizer=s,this.httpClient=i,this.alertCtrl=e,this.evaBotService=n,this.modalCtrl=a,this.commonUtil=o,this.angularService=h,this.renderer=d,this.elementRef=l,this.isEvaClient=!1,this.evaSpeechEnabled=r.EVA_BOT_CONFIG.evaSpeechEnabled,this.disableTTS=r.EVA_BOT_CONFIG.disableTTS,this.isActivelyAwaitingUserResponse=r.EVA_BOT_CONFIG.isActivelyAwaitingUserResponse,this.styleOptions=r.EVA_BOT_CONFIG.styleOptions,this.webSpeechPonyFillFactoryOptions=r.EVA_BOT_CONFIG.webSpeechPonyFillFactoryOptions,this.isCsrSession=!1,this.userId=r.EVA_BOT_CONFIG.connectionOptions.user,this.settingsIcon=O.BASE_IMAGES+"settings.svg",this.languageIcon=O.BASE_IMAGES+"language.svg",this.resetchatIcon=O.BASE_IMAGES+"reload.svg",this.selectedUserSettings=[],this.customTTSEnabled=!1,this.customTTSResponseQueue=[],this.customTTSResponseQueueCurrentIndex=0,this.customTTSAudioQueue=[],this.customTTSAudioQueueCurrentIndex=0,this.customTTSAudioElement=new Audio,this.customTTSDictating=!1,this.CONSTANT_SESSION_ID="session_id",this.avatar_activate=!1,this.customInteractionHandler=[{name:"Openstream.MyCustomInteraction",handler:function({config:S,...E}){return new Promise((v,H)=>{setTimeout(()=>{v({status:"success",result:{data:"InteractionResult"}})},2e3)})}}],window.WebchatPageRef={component:this},window.evaWebkitCameraImageResponse=this.evaWebkitCameraImageResponse.bind(this)}ngOnInit(){this.initializeData()}ngAfterViewInit(){this.loadAvatarframe()}ngOnDestroy(){A.EVABotClient.disconnect(),this.subscription&&this.subscription.unsubscribe(),this.stopCustomTTSDictating(),this.clearCustomTTSQueue()}ionViewWillEnter(){this.loadEVABot(null)}ionViewDidEnter(){this.handleEventListeners()}initializeData(){var i,e,n,a,o,h,d;this.voiceType="en-US-JennyNeural",this.supportedLanguages=null==(i=null==r?void 0:r.EVA_BOT_CONFIG)?void 0:i.supportedLanguages,this.langSelectorOptions={title:"Languages",subTitle:"Select your preferred language"},this.userlocale=navigator&&navigator.language?navigator.language:"en-US",this.selectedLanguage="en";const s=null==(e=null==r?void 0:r.EVA_BOT_CONFIG)?void 0:e.evaSpeechEnabled;if(this.avatar_activate=null==(n=null==r?void 0:r.EVA_AVATAR_CONFIG)?void 0:n.activateAvatar,this.customTTSEnabled=null==(a=null==r?void 0:r.EVA_TTS_CONFIG)?void 0:a.enabled,this.selectedUserSettings=null==(o=null==r?void 0:r.EVA_BOT_CONFIG)?void 0:o.userSettings,this.selectedUserSettings&&this.selectedUserSettings.length>0)for(let l=0;l<this.selectedUserSettings.length;l++)if("speech"==this.selectedUserSettings[l].id&&(this.selectedUserSettings[l].checked=s),"avatar"==this.selectedUserSettings[l].id&&(this.selectedUserSettings[l].checked=this.avatar_activate),"botdomain"==this.selectedUserSettings[l].id){const S=null==(d=null==(h=null==r?void 0:r.EVA_BOT_CONFIG)?void 0:h.connectionOptions)?void 0:d.domain;if(S&&this.selectedUserSettings[l].options&&this.selectedUserSettings[l].options.length>0)for(let E=0;E<this.selectedUserSettings[l].options.length;E++){const v=this.selectedUserSettings[l].options[E];v.value==S&&(this.selectedUserSettings[l].selected=v.id)}}this.validateCustomTTS(),this.createNewAvatarSession()}validateCustomTTS(){var s,i;this.disableTTS=null==(s=null==r?void 0:r.EVA_BOT_CONFIG)?void 0:s.disableTTS,this.customTTSEnabled=null==(i=null==r?void 0:r.EVA_TTS_CONFIG)?void 0:i.enabled,1==this.customTTSEnabled&&1==this.disableTTS&&"en"!=this.selectedLanguage&&(this.disableTTS=!1,this.customTTSEnabled=!1)}loadEVABot(s,i){var e=this;return(0,g.A)(function*(){e.stopCustomTTSDictating(),e.clearCustomTTSQueue(),e.botappid=s||r.EVA_BOT_CONFIG.connectionOptions.botappid,e.botdomain=i||r.EVA_BOT_CONFIG.connectionOptions.domain,e.connectionOptions={token:r.EVA_BOT_CONFIG.connectionOptions.bottoken?yield e.getToken(r.EVA_BOT_CONFIG.connectionOptions.bottoken):e.botappid,domain:e.botdomain,webSocket:r.EVA_BOT_CONFIG.connectionOptions.webSocket},!e.isEvaClient&&e.evaSpeechEnabled?e.disableTTS?e.evaBotService.createHybridPonyfillFactory(e.webSpeechPonyFillFactoryOptions).then(n=>{console.log("WebchatPage :: loadEVABot :: createHybridPonyfillFactory :: data = ",n),e.renderWebchatAndSendEvent(n)}).catch(n=>{console.log("WebchatPage :: loadEVABot :: createHybridPonyfillFactory :: error = ",n),e.renderWebchatAndSendEvent()}):e.evaBotService.createCognitiveServicesSpeechServicesPonyfillFactory(e.webSpeechPonyFillFactoryOptions).then(n=>{console.log("WebchatPage :: loadEVABot :: createCognitiveServicesSpeechServicesPonyfillFactory :: data = ",n),e.renderWebchatAndSendEvent(n)}).catch(n=>{console.log("WebchatPage :: loadEVABot :: createCognitiveServicesSpeechServicesPonyfillFactory :: error = ",n),e.renderWebchatAndSendEvent()}):setTimeout(()=>{e.renderWebchatAndSendEvent()},500)})()}renderWebchatAndSendEvent(s){const i=document.getElementById("webchat");let e={enableSpeech:this.evaSpeechEnabled};if(s&&s.hasOwnProperty("webSpeechPonyfillFactory")&&(e.webSpeechPonyfillFactory=s.webSpeechPonyfillFactory),e.clearStore=!0,this.evaSpeechEnabled&&this.voiceType&&this.supportedLanguages){let a;for(let o=0;o<this.supportedLanguages.length;o++)this.supportedLanguages[o].voice_type==this.voiceType&&this.supportedLanguages[o].tts_voicename&&(a=this.supportedLanguages[o].tts_voicename);if(a){const o=new RegExp(a,"iu"),h=(d,l)=>d.find(({name:S})=>o.test(S));h&&(e.selectVoice=h)}}e.locale=this.userlocale;const n=this.getChatMessageHook();n&&(e.chatMessageHook=n),this.evaBotService.renderBotClient(i,this.connectionOptions,this.styleOptions,e,this.customInteractionHandler),setTimeout(()=>{this.sendEventToWebchat()},2e3)}closeModal(){var s;this.stopCustomTTSDictating(),this.clearCustomTTSQueue(),null==(s=this.modalCtrl)||s.dismiss(),this.evabotwebviewCloseView()}sendSetSendBox(s){this.evaBotService.sendBotMessageActivity(s).then(i=>{console.log("WebchatPage :: sendBotMessageActivity :: data = ",i)}).catch(i=>{console.log("WebchatPage :: sendBotMessageActivity :: error = ",i)})}resetChat(){this.clearCustomTTSQueue(),this.stopCustomTTSDictating(),A.EVABotClient.instance().store.dispatch({type:"WEB_CHAT/SEND_MESSAGE_BACK",payload:{text:m.RESTART_CMD}})}sendEventToWebchat(){const s=this.getWebchatEventPayload();s&&this.evaBotService.sendEventToWebchat(s).then(i=>{console.log("WebchatPage :: sendEventToWebchat :: payload = ",s," :: data = ",i)}).catch(i=>{console.log("WebchatPage :: sendEventToWebchat :: payload = ",s," :: error = ",i)})}getChatMessageHook(){let s=null;Date.now();try{s={speechMessage:null,"WEB_CHAT/SEND_POST_BACK":({type:e,payload:n,...a})=>{if(console.log("Chat Message HOOK :: WEB_CHAT/SEND_POST_BACK :: type = ",e," :: payload = ",n),n)return window.chatSpeechEvents.setTapped(n.value),!0},"WEB_CHAT/START_SPEAKING":({type:e,payload:n,...a})=>{console.log("Chat Message HOOK :: WEB_CHAT/START_SPEAKING :: Speech STARTED")},"WEB_CHAT/STOP_SPEAKING":({type:e,payload:n,...a})=>{console.log("Chat Message HOOK :: WEB_CHAT/STOP_SPEAKING :: Speech STOPPED")},"DIRECT_LINE/INCOMING_ACTIVITY":({type:e,payload:n,...a})=>{if(console.log("Chat Message HOOK :: DIRECT_LINE/INCOMING_ACTIVITY :: type = ",e," :: payload = ",n),n&&n.activity){let o=n.activity.text;if(o){if(1==this.customTTSEnabled&&!this.isEvaClient&&this.evaSpeechEnabled&&n.activity.from&&"bot"==n.activity.from.role&&this.playCustomTTS(o),o=o.toLowerCase(),-1!=o.indexOf(m.EVA_BOT_SERVER)){const h=this.getUrlParameterValue(o,"rt");let d="CSR wants to have a call with you. Do you want to continue?";return h&&"video"==h.toLowerCase()&&(d="CSR wants to have a video call with you. Do you want to continue?"),this.showAlert("Confirm",d,m.ALERT_TYPE_CONFIRM).then(S=>{S.role===m.ALERT_ROLE_OK?this.openLink(o):console.log("User denied conference call")}),!0}if(-1!=o.indexOf("espere mientras lo conectamos con un agente")||-1!=o.indexOf("thanks, you are now chatting with"))this.isCsrSession=!0,setTimeout(()=>{scxmlHandler.setAgentChatIcon()},100);else if(-1!=o.indexOf("closed the conversation"))this.isCsrSession=!1;else if(1==this.isCsrSession)setTimeout(()=>{scxmlHandler.setAgentChatIcon()},100);else if(o===m.RESTART_CMD.toLowerCase())return console.log("restart thread received"),scxmlHandler.hideAllConversationMessages(),this.sendEventToWebchat(),!0}!this.isActivelyAwaitingUserResponse&&"expectingInput"==n.activity.inputHint&&(n.activity.inputHint="ignoringInput")}}}}catch(e){console.log("WebchatPage :: getChatMessageHook :: Error = ",e)}return s}getUrlParameterValue(s,i){if(!s)return null;const e=new URL(s);return e&&e.searchParams.has(i)?e.searchParams.get(i):null}openLink(s){this.commonUtil.openLink(s)}showAlert(s,i,e){var n=this;return(0,g.A)(function*(){let a;e===m.ALERT_TYPE_ALERT?a={buttons:[{text:m.MESSAGE_ALERT_OK,role:m.ALERT_ROLE_OK}],message:i,header:s}:e===m.ALERT_TYPE_CONFIRM&&(a={buttons:[{text:m.MESSAGE_ALERT_YES,role:m.ALERT_ROLE_OK,handler:()=>{}},{text:m.MESSAGE_ALERT_NO,role:m.ALERT_ROLE_CANCEL,handler:()=>{}}],message:i,header:s});const o=yield n.alertCtrl.create(a);return yield o.present(),yield o.onDidDismiss()})()}getWebchatEventPayload(){let s=null;try{const i=Date.now();s={name:"setusercontext",value:{sessionID:this.avatar_session_id?this.avatar_session_id:i,speaker:this.voiceType,user_locale:this.userlocale,user_timezone:this.getTimeZoneName(),isEvaclient:this.isEvaClient?"EVA":"Web",avatarSessionId:this.avatar_session_id?this.avatar_session_id:i}}}catch(i){console.log("WebchatPage :: getWebchatEventPayload :: error = ",i)}return s}getTimeZoneName(){let s="America/New_York";try{switch(s=Intl.DateTimeFormat().resolvedOptions().timeZone,s){case"Asia/Calcutta":s="Asia/Kolkata";break;case"Asia/Katmandu":s="Asia/Kathmandu";break;case"America/Indianapolis":s="America/Indiana/Indianapolis";break;case"America/Buenos_Aires":s="America/Argentina/Buenos_Aires";break;case"Asia/Rangoon":s="Asia/Yangon"}}catch(i){console.log("WebchatPage :: getTimeZoneName :: Error = ",i)}return console.log("WebchatPage :: getTimeZoneName :: timeZoneName = ",s),s}getToken(s){var i=this;return(0,g.A)(function*(){console.log("webchat getToken: ");const e=Math.floor(1e3+9e3*Math.random());let n=i.userId;n||(n=(new Date).getTime()),console.log("webchatmodal : userid="+n);const a=r.EVA_BOT_CONFIG.connectionOptions.botappid;i.botappid=a;let o="p-"+n+"-"+e;i.isEvaClient&&(o="m-"+n+"-"+e);const h=yield fetch(r.EVA_BOT_CONFIG.connectionOptions.tokengeneratorserver,{method:"POST",headers:new Headers({"content-type":"application/json",Authorization:"Bearer "+s}),body:`{\n        "projectId": "${a}",\n        "userId": "${n}",\n        "userName": "${n}",\n        "conversationId": "${o}",\n      }`}).then(d=>d.status>=400&&d.status<600?(console.log("Bad response from generate token server"),null):d).catch(d=>(console.log("getToken :: error",d),null));if(h){const{token:d}=yield h.json();return d}return null})()}selectLanguage(){var s;null==(s=this.langSelectRef)||s.open()}onChangeOfLanguage(s){var i=this;return(0,g.A)(function*(){var n,a,o,h,d;const e=null==(n=null==s?void 0:s.detail)?void 0:n.value;if(i.supportedLanguages&&e){"ar"==e?null==(o=null==(a=null==document?void 0:document.body)?void 0:a.classList)||o.add("webchat-textalign-right"):null==(d=null==(h=null==document?void 0:document.body)?void 0:h.classList)||d.remove("webchat-textalign-right");for(let l=0;l<i.supportedLanguages.length;l++)i.supportedLanguages[l].lang_code==e&&(i.userlocale=i.supportedLanguages[l].code,i.voiceType=i.supportedLanguages[l].voice_type);i.validateCustomTTS(),i.registerAvatarSpeaker(),yield i.angularService.showLoader({spinner:"bubbles"}).catch(l=>{}),A.EVABotClient.disconnect().then((0,g.A)(function*(){yield new Promise(l=>setTimeout(l,3e3)),yield i.loadEVABot(i.botappid,i.botdomain).catch(l=>{}),i.angularService.hideLoader().catch(l=>{})})).catch(l=>{i.angularService.hideLoader().catch(S=>{})})}})()}openUserSettingsModal(){var s=this;return(0,g.A)(function*(){let i=yield s.modalCtrl.create({component:V,componentProps:{selectedUserSettings:s.selectedUserSettings},cssClass:"webchat-settings-modal"});i.onDidDismiss().then(e=>{e&&"confirm"==e.role&&e.data&&(s.selectedUserSettings=e.data,s.updateUserSettings())}),yield i.present()})()}updateUserSettings(){var s=this;return(0,g.A)(function*(){if(s.selectedUserSettings){s.stopCustomTTSDictating(),s.clearCustomTTSQueue();let i=null;for(let e=0;e<s.selectedUserSettings.length;e++){const a="toggle"==s.selectedUserSettings[e].type?s.selectedUserSettings[e].checked:s.selectedUserSettings[e].selected;switch(s.selectedUserSettings[e].id){case"speech":s.evaSpeechEnabled="speech"==(1==a?"speech":"text");break;case"avatar":s.avatar_activate=1==a;break;case"botdomain":s.selectedUserSettings[e].options.forEach(o=>{o.id==a&&(i=o.value)})}}s.validateCustomTTS(),s.avatar_activate&&(s.avatar_activate=!1,yield new Promise(e=>setTimeout(e,1e3)),s.avatar_activate=!0,s.createNewAvatarSession(),yield new Promise(e=>setTimeout(e,1e3)),s.loadAvatarframe()),yield s.angularService.showLoader({spinner:"bubbles"}).catch(e=>{}),A.EVABotClient.disconnect().then((0,g.A)(function*(){yield new Promise(e=>setTimeout(e,3e3)),yield s.loadEVABot(s.botappid,i).catch(e=>{}),s.angularService.hideLoader().catch(e=>{})})).catch(e=>{s.angularService.hideLoader().catch(n=>{})})}})()}handleMessageListeners(){var s=this;return(0,g.A)(function*(){yield s.angularService.showLoader({spinner:"bubbles"}).catch(i=>{}),window.addEventListener("message",i=>{var e;try{null!=(e=null==i?void 0:i.data)&&e.botappid&&A.EVABotClient.disconnect().then(()=>{setTimeout((0,g.A)(function*(){yield s.loadEVABot(i.data.botappid,s.botdomain).catch(n=>{}),s.angularService.hideLoader().catch(n=>{})}),3e3)}).catch(n=>{s.angularService.hideLoader().catch(a=>{})})}catch{s.angularService.hideLoader().catch(a=>{})}})})()}handleEventListeners(){var i,e,n;const s=null==(e=null==(i=this.elementRef)?void 0:i.nativeElement)?void 0:e.querySelector(".webchat__icon-button");s&&(null==(n=this.renderer)||n.listen(s,"click",()=>{this.handleMicClick()}))}handleMicClick(){this.toggleCustomTTSDictating(),this.clearCustomTTSQueue()}clearCustomTTSQueue(){this.customTTSAudioElement&&(this.customTTSAudioElement.src="",this.customTTSAudioElement.pause()),this.customTTSAudioQueue=[],this.customTTSAudioQueueCurrentIndex=0,this.customTTSResponseQueue=[],this.customTTSResponseQueueCurrentIndex=0}toggleCustomTTSDictating(){this.customTTSDictating=!this.customTTSDictating}stopCustomTTSDictating(){this.customTTSDictating=!1}playCustomTTS(s){1==this.customTTSEnabled?s&&(0==this.customTTSResponseQueue.length?(this.customTTSResponseQueue.push(s),this.peformCustomTTS()):this.customTTSResponseQueue.push(s)):(this.stopCustomTTSDictating(),this.clearCustomTTSQueue())}peformCustomTTS(){var n,s=this;try{if(1==this.customTTSEnabled)if(this.customTTSResponseQueueCurrentIndex<this.customTTSResponseQueue.length){const i=this.customTTSResponseQueue[this.customTTSResponseQueueCurrentIndex],e=new FormData;e.append("input_text",i),e.append("voice_name",r.EVA_TTS_CONFIG.voice_name),e.append("tts_client",r.EVA_TTS_CONFIG.tts_client),this.angularService.makeHTTPRequest("post",r.EVA_TTS_SYNTHESIZESPEECH_URL+"/"+this.botappid,e).subscribe({next:(n=(0,g.A)(function*(a){if(a&&a.audio_url){const o=r.EVA_TTS_DOWNLOADAUDIO_URL+a.audio_url;0==s.customTTSAudioQueue.length?(s.customTTSAudioQueue.push(o),s.playCustomTTSAudio()):s.customTTSAudioQueue.push(o),s.customTTSResponseQueueCurrentIndex++,s.peformCustomTTS()}}),function(o){return n.apply(this,arguments)}),error:n=>{console.log(n),this.customTTSResponseQueueCurrentIndex++,this.peformCustomTTS()}})}else this.customTTSResponseQueueCurrentIndex=0,this.customTTSResponseQueue=[];else this.stopCustomTTSDictating(),this.clearCustomTTSQueue()}catch(i){console.log(i)}}playCustomTTSAudio(){try{1==this.customTTSEnabled?this.customTTSAudioQueueCurrentIndex<this.customTTSAudioQueue.length?this.customTTSAudioElement&&(this.customTTSAudioElement.src=this.customTTSAudioQueue[this.customTTSAudioQueueCurrentIndex],this.customTTSAudioElement.load(),this.customTTSAudioElement.play().then(()=>{this.customTTSAudioElement.onended=()=>{this.customTTSAudioQueueCurrentIndex++,this.playCustomTTSAudio()}}).catch(s=>{console.log("WebchatPage :: playCustomTTSAudio :: error = ",s),this.customTTSAudioQueueCurrentIndex++,this.playCustomTTSAudio()})):(this.customTTSAudioQueueCurrentIndex=0,this.customTTSAudioQueue=[]):(this.stopCustomTTSDictating(),this.clearCustomTTSQueue())}catch(s){console.log(s)}}createNewAvatarSession(){if(this.avatar_activate){this.disableTTS=!0,this.customTTSEnabled=!1;const s=sessionStorage?sessionStorage.getItem(this.CONSTANT_SESSION_ID):null;s?(this.avatar_session_id=s,this.domSanitizer.bypassSecurityTrustResourceUrl(r.EVA_AVATAR_STREAMING_APP_URL+this.avatar_session_id)):(this.avatar_session_id=Date.now(),sessionStorage&&(sessionStorage.setItem(this.CONSTANT_SESSION_ID,this.avatar_session_id),this.domSanitizer.bypassSecurityTrustResourceUrl(r.EVA_AVATAR_STREAMING_APP_URL+this.avatar_session_id)));const i=(new Date).toISOString(),e=new Date,n=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`;let a=new FormData;a.append(this.CONSTANT_SESSION_ID,this.avatar_session_id),a.append("user",r.EVA_AVATAR_CONFIG.user),a.append("application",r.EVA_AVATAR_CONFIG.application),a.append("start_time",i),a.append("date",n),a.append("stream",r.EVA_AVATAR_CONFIG.stream),a.append("avatar",r.EVA_AVATAR_CONFIG.avatar),a.append("base",r.EVA_AVATAR_CONFIG.base),a.append("speaker",this.voiceType?this.voiceType:r.EVA_AVATAR_CONFIG.speaker),this.httpClient.post(r.EVA_AVATAR_SESSION_API_URL,a).subscribe({next:o=>{this.registerAvatarSpeaker()},error:o=>{console.log(o)}})}}registerAvatarSpeaker(){if(this.avatar_activate&&this.avatar_session_id){let s=new FormData;s.append("session_id",this.avatar_session_id),s.append("speaker",this.voiceType?this.voiceType:r.EVA_AVATAR_CONFIG.speaker),this.httpClient.put(r.EVA_AVATAR_SESSION_API_URL+"/speaker",s).subscribe({next:i=>{},error:i=>{console.log(i)}})}}logoutAvatarSession(){sessionStorage&&sessionStorage.getItem(this.CONSTANT_SESSION_ID)&&sessionStorage.removeItem(this.CONSTANT_SESSION_ID),this.avatar_session_id&&this.httpClient.delete(r.EVA_AVATAR_SESSION_API_URL+"/"+this.avatar_session_id).subscribe({next:s=>{},error:s=>{console.log(s)}})}loadAvatarframe(){this.avatar_activate&&(this.avatar_url=this.domSanitizer.bypassSecurityTrustResourceUrl(this.avatar_session_id?r.EVA_AVATAR_STREAMING_APP_URL+this.avatar_session_id:r.EVA_AVATAR_STREAMING_APP_ERROR_URL))}evabotwebviewCloseView(){var s;null==(s=null==window?void 0:window.evabotwebview)||s.closeView()}evabotwebviewTakePicture(){var s;null==(s=null==window?void 0:window.evabotwebview)||s.takePicture()}openCamera(){this.evabotwebviewTakePicture()}evaWebkitCameraImageResponse(s){console.log("WebchatPage :: evaWebkitCameraImageResponse :: data = ",s)}}(_=m).RESTART_CMD="restart thread",_.EVA_BOT_SERVER=r.EVA_BOT_CONFIG.botserverdomain,_.ALERT_TYPE_ALERT="alert",_.ALERT_TYPE_CONFIRM="confirm",_.ALERT_ROLE_OK="ok",_.ALERT_ROLE_CANCEL="cancel",_.MESSAGE_ALERT_OK="Ok",_.MESSAGE_ALERT_YES="Yes",_.MESSAGE_ALERT_NO="No",_.\u0275fac=function(s){return new(s||_)(t.rXU(y.up),t.rXU(b.Qq),t.rXU(u.hG),t.rXU(I.L9),t.rXU(u.W3),t.rXU(M),t.rXU(B),t.rXU(t.sFG),t.rXU(t.aKT))},_.\u0275cmp=t.VBU({type:_,selectors:[["app-webchat"]],viewQuery:function(s,i){if(1&s&&t.GBs(U,5),2&s){let e;t.mGM(e=t.lsd())&&(i.langSelectRef=e.first)}},decls:23,vars:5,consts:[["langSelect",""],["audioPlayer",""],[1,"content"],[1,"ion-no-padding","height-100","customgrid"],[1,"ion-no-padding","height-100"],[1,"card_title"],["title","Camera",1,"cursor-pointer","webchaticons","icon-camera",3,"click"],["title","Settings",1,"cursor-pointer","webchaticons","icon-settings",3,"click"],["title","Language",1,"cursor-pointer","webchaticons","icon-language",3,"click"],["interface","alert",1,"display-none",3,"ngModelChange","ionChange","interfaceOptions","ngModel"],[3,"value",4,"ngFor","ngForOf"],["title","Refresh",1,"cursor-pointer","webchaticons","icon-resetchat",3,"click"],["title","Close",1,"cursor-pointer","webchaticons","icon-close",3,"click"],["class","height-100",4,"ngIf"],["controls","","autoplay","","hidden",""],["type","audio/mpeg"],[3,"value"],[1,"height-100"],[1,"height-40"],["frameBorder","0","scrolling","no","allowfullscreen","true","allow","autoplay","id","avatarFrame","name","avatarFrame",1,"width-100","height-100",3,"src"],[1,"height-60"],["id","webchat","role","main",1,"height-100"]],template:function(s,i){if(1&s){const e=t.RV6();t.j41(0,"ion-content",2)(1,"ion-grid",3)(2,"ion-row",4)(3,"ion-col",4)(4,"div",5)(5,"span",6),t.bIt("click",function(){return t.eBV(e),t.Njj(i.openCamera())}),t.k0s(),t.EFF(6," \xa0 "),t.j41(7,"span",7),t.bIt("click",function(){return t.eBV(e),t.Njj(i.openUserSettingsModal())}),t.k0s(),t.EFF(8," \xa0 "),t.j41(9,"span",8),t.bIt("click",function(){return t.eBV(e),t.Njj(i.selectLanguage())}),t.k0s(),t.EFF(10," \xa0 "),t.j41(11,"ion-select",9,0),t.mxI("ngModelChange",function(a){return t.eBV(e),t.DH7(i.selectedLanguage,a)||(i.selectedLanguage=a),t.Njj(a)}),t.bIt("ionChange",function(a){return t.eBV(e),t.Njj(i.onChangeOfLanguage(a))}),t.DNE(13,G,2,2,"ion-select-option",10),t.k0s(),t.j41(14,"span",11),t.bIt("click",function(){return t.eBV(e),t.Njj(i.resetChat())}),t.k0s(),t.EFF(15," \xa0 "),t.j41(16,"span",12),t.bIt("click",function(){return t.eBV(e),t.Njj(i.closeModal())}),t.k0s(),t.EFF(17," \xa0 "),t.k0s(),t.DNE(18,W,5,1,"div",13)(19,x,2,0,"div",13),t.j41(20,"audio",14,1),t.nrm(22,"source",15),t.k0s()()()()()}2&s&&(t.R7$(11),t.Y8G("interfaceOptions",i.langSelectorOptions),t.R50("ngModel",i.selectedLanguage),t.R7$(2),t.Y8G("ngForOf",i.supportedLanguages),t.R7$(5),t.Y8G("ngIf",1==i.avatar_activate&&i.avatar_session_id),t.R7$(),t.Y8G("ngIf",!i.avatar_activate||!i.avatar_session_id))},dependencies:[f.Sq,f.bT,C.BC,C.vS,u.hU,u.W9,u.lO,u.ln,u.Nm,u.Ip,u.Je],styles:[".cursor-pointer[_ngcontent-%COMP%]{cursor:pointer}.display-none[_ngcontent-%COMP%]{display:none}.height-100[_ngcontent-%COMP%]{height:100%}.height-60[_ngcontent-%COMP%]{height:60%}.height-40[_ngcontent-%COMP%]{height:40%}.content[_ngcontent-%COMP%]{margin:0 auto;--background: #fff}.card_title[_ngcontent-%COMP%]{padding:.2rem;font-family:Times New Roman,Arial,Verdana,Tahoma,sans-serif;border-top:0px solid #ff6600;text-align:right;position:fixed;top:0;right:0;z-index:10}.customgrid[_ngcontent-%COMP%]{background:var(--eva-color-dark-shade)}.avatarFrame[_ngcontent-%COMP%]{width:100%;height:100%;background-color:transparent;overflow:hidden}#webchat[_ngcontent-%COMP%]{-webkit-user-select:text!important;user-select:text!important;background-color:#fff;padding-bottom:env(safe-area-inset-bottom)!important;height:calc(98% - env(safe-area-inset-bottom));width:100%}#webchat[_ngcontent-%COMP%]   .ac-textBlock[_ngcontent-%COMP%]{white-space:normal!important}.webchaticons[_ngcontent-%COMP%]{display:inline-block;width:2.25rem;height:2.25rem;background-size:cover}.icon-camera[_ngcontent-%COMP%]{background-image:url(camera.38defe9705f6a302.svg)}.icon-camera[_ngcontent-%COMP%]:hover{background-image:url(camera-blue.ab32d4c0849af632.svg)}.icon-settings[_ngcontent-%COMP%]{background-image:url(settings.ec5227ff4eabc0ea.svg)}.icon-settings[_ngcontent-%COMP%]:hover{background-image:url(settings-blue.926fe797a28282a7.svg)}.icon-language[_ngcontent-%COMP%]{background-image:url(language.fa1c8c3dc4412cc4.svg)}.icon-language[_ngcontent-%COMP%]:hover{background-image:url(language-blue.91c130ead477132a.svg)}.icon-resetchat[_ngcontent-%COMP%]{background-image:url(reload.d9259d5879483392.svg)}.icon-resetchat[_ngcontent-%COMP%]:hover{background-image:url(reload-blue.0ed6550d7e2e1de4.svg)}.icon-close[_ngcontent-%COMP%]{background-image:url(close.5aa6c82f049a6298.svg)}.icon-close[_ngcontent-%COMP%]:hover{background-image:url(close-blue.82053eb54f48d398.svg)}"]})}}]);